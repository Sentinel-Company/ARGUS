version: '3.8'

services:
  neo4j:
    image: neo4j:5.15
    container_name: argus-neo4j
    environment:
      NEO4J_AUTH: neo4j/argus_secure_password
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - argus-network

  ipfs:
    image: ipfs/kubo:latest
    container_name: argus-ipfs
    ports:
      - "4001:4001"  # P2P swarm
      - "5001:5001"  # API
      - "8080:8080"  # Gateway
    volumes:
      - ipfs_data:/data/ipfs
      - ipfs_staging:/export
    networks:
      - argus-network
    command: daemon --migrate=true --enable-gc

  redis:
    image: redis:7-alpine
    container_name: argus-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - argus-network

  postgres:
    image: postgres:15
    container_name: argus-postgres
    environment:
      POSTGRES_DB: argus
      POSTGRES_USER: argus
      POSTGRES_PASSWORD: argus_db_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - argus-network

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: argus-api
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8000:8000"
    depends_on:
      - neo4j
      - redis
      - ipfs
      - postgres
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: argus_secure_password
      REDIS_URL: redis://redis:6379
      IPFS_API: /dns/ipfs/tcp/5001/http
      POSTGRES_URI: postgresql://argus:argus_db_password@postgres:5432/argus
    volumes:
      - ./api:/app
      - ./data:/app/data
    networks:
      - argus-network

  worker:
    build:
      context: ./worker
      dockerfile: Dockerfile
    container_name: argus-worker
    command: celery -A tasks worker --loglevel=info --concurrency=4
    depends_on:
      - redis
      - neo4j
      - ipfs
    environment:
      REDIS_URL: redis://redis:6379
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: argus_secure_password
      IPFS_API: /dns/ipfs/tcp/5001/http
    volumes:
      - ./worker:/app
      - ./data:/app/data
      - ./models:/app/models
    networks:
      - argus-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: argus-frontend
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://localhost:8000
      REACT_APP_IPFS_GATEWAY: http://localhost:8080
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - argus-network

  p2p-node:
    build:
      context: ./p2p
      dockerfile: Dockerfile
    container_name: argus-p2p-node
    ports:
      - "9000:9000"  # Libp2p swarm
    environment:
      BOOTSTRAP_PEERS: /dns4/bootstrap1.argus.network/tcp/9000/p2p/12D3KooW...
    volumes:
      - p2p_data:/data
    networks:
      - argus-network

volumes:
  neo4j_data:
  neo4j_logs:
  ipfs_data:
  ipfs_staging:
  redis_data:
  postgres_data:
  p2p_data:

networks:
  argus-network:
    driver: bridge
